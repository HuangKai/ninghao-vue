<template>
  <h3>{{ name }}</h3>
  <UserLogin
    v-if="!isLoggedIn"
    @login-success="onLoginSuccess"
    @login-error="onLoginError"
  />

  <div v-if="currentUser">
    <div>{{ currentUser.name }}</div>
    <button @click="logout">退出</button>
  </div>

  <input
    v-if="isLoggedIn"
    type="text"
    v-model="title"
    @keyup.enter="createPost"
    placeholder="输入内容标题"
  />

  <input
    type="file"
    ref="file"
    @change="onChangeFile"
    accept="image/png, image/jpeg, image/jpg"
  />

  <div
    :class="['drag-zone', { active: dragZoneActive }]"
    @dragover.prevent
    @drop.prevent="onDropDragZone"
    @dragenter="dragZoneActive = true"
    @dragleave="dragZoneActive = false"
  >
    <div>把图像文件拖放到这里</div>
  </div>

  <div v-if="imageUploadProgress">
    <span class="image-upload-progress">{{ imageUploadProgress + '%' }}</span>
  </div>

  <div v-if="imagePreviewUrl">
    <img class="image-preview" :src="imagePreviewUrl" />
  </div>

  <div>{{ errorMessage }}</div>

  <div v-for="post in posts" :key="post.id">
    <input
      type="text"
      :value="post.title"
      @keyup.enter="updatePost($event, post.id)"
    />
    <button @click="deletePost(post.id)">删除</button>
    {{ post.title }} -
    <small>{{ post.user.name }}</small>
  </div>
</template>

<script>
import { apiHttpClient } from '@/app/app.service';
import UserLogin from '@/user/components/user-login.vue';

export default {
  data() {
    return {
      name: '宁皓网',
      posts: [],
      errorMessage: '',
      errorResponse: '',
      token: '',
      title: '',
      currentUser: null,
      file: null,
      imagePreviewUrl: null,
      imageUploadProgress: null,
      dragZoneActive: false,
    };
  },

  computed: {
    isLoggedIn() {
      return this.token ? true : false;
    },
  },

  async created() {
    this.getPosts();

    const tid = localStorage.getItem('tid');
    const uid = localStorage.getItem('uid');

    if (tid) this.token = tid;
    if (uid) this.getCurrentUser(uid);
  },

  methods: {
    onDropDragZone(event) {
      console.log(event.dataTransfer.files);

      // 鼠标在拖动区域松开后也要恢复默认样式
      this.dragZoneActive = false;

      const file = event.dataTransfer.files[0];

      if (file) {
        this.file = file;

        // 设置内容标题
        this.title = file.name.split('.')[0];

        // 生成预览图
        this.createImagePreview(file);
      }
    },

    // 创建文件对象
    async createFile(file, postId) {
      // 创建表单
      const formData = new FormData();

      // 添加字段
      formData.append('file', file);

      // 上传文件
      try {
        const response = await apiHttpClient.post(
          `/files?post=${postId}`,
          formData,
          {
            headers: {
              Authorization: `Bearer ${this.token}`,
            },
            onUploadProgress: event => {
              console.log(event);

              const { loaded, total } = event;
              this.imageUploadProgress = Math.round((loaded * 100) / total);
            },
          },
        );

        // 清理
        this.file = null;
        this.imagePreviewUrl = null;
        this.$refs.file.value = '';
        this.imageUploadProgress = null;

        console.log('createFile', response.data);
      } catch (error) {
        this.errorMessage = error.message;
      }
    },

    // 生成预览图
    createImagePreview(file) {
      const reader = new FileReader();
      reader.readAsDataURL(file);

      reader.onload = event => {
        this.imagePreviewUrl = event.target.result;
      };
    },

    // 监听选择的文件
    onChangeFile(event) {
      console.log(event.target.files);

      const file = event.target.files[0];

      if (file) {
        this.file = file;
        this.title = file.name.split('.')[0];

        // 生成预览图像
        this.createImagePreview(file);
      }
    },

    logout() {
      this.token = '';
      this.currentUser = null;

      localStorage.removeItem('tid');
      localStorage.removeItem('uid');
    },

    // 获取当前用户数据
    async getCurrentUser(userId) {
      try {
        const response = await apiHttpClient.get(`/users/${userId}`);

        this.currentUser = response.data;
      } catch (error) {
        /**
         * 下面这行查看示例代码发现没有中间无须 .data
         */
        // this.errorMessage = error.data.message;
        this.errorMessage = error.message;
      }
    },

    // 登录成功
    onLoginSuccess(data) {
      this.token = data.token;
      this.getCurrentUser(data.id);

      localStorage.setItem('tid', data.token);
      localStorage.setItem('uid', data.id);
    },

    // 登录失败
    onLoginError(error) {
      this.errorMessage = error.data.message;
    },

    // 删除内容
    async deletePost(postId) {
      try {
        await apiHttpClient.delete(`/posts/${postId}`, {
          headers: {
            Authorization: `Bearer ${this.token}`,
          },
        });

        this.getPosts();
      } catch (error) {
        this.errorMessage = error.message;
      }
    },

    // 更新内容
    async updatePost(event, postId) {
      console.log(event.target.value);
      console.log(postId);

      try {
        await apiHttpClient.patch(
          `/posts/${postId}`,
          {
            title: event.target.value,
          },
          {
            headers: {
              Authorization: `Bearer ${this.token}`,
            },
          },
        );

        this.getPosts();
      } catch (error) {
        this.errorMessage = error.message;
      }
    },

    // 获取内容列表
    async getPosts() {
      try {
        const response = await apiHttpClient.get('/posts');

        this.posts = response.data;
      } catch (error) {
        this.errorMessage = error.message;
      }
    },

    // 创建内容
    async createPost() {
      try {
        const response = await apiHttpClient.post(
          '/posts',
          {
            title: this.title,
          },
          {
            headers: {
              Authorization: `Bearer ${this.token}`,
            },
          },
        );

        console.log('createPost', response.data);

        if (this.file) {
          this.createFile(this.file, response.data.insertId);
        }

        this.title = '';

        this.getPosts();
      } catch (error) {
        this.errorMessage = error.message;
      }
    },
  },
  components: {
    UserLogin,
  },
};
</script>

<style>
@import './styles/app.css';
</style>
